<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-GB">
<head profile="http://gmpg.org/xfn/11">
	<title>tom bh</title>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<meta name="google-site-verification" content="Me_DN7gOhDhF0PNu5ALBSOd-_362oOMSMAQXOFmEuXI" />

	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
	
	<link rel="stylesheet" type="text/css" href="/css/style.css" />
	<link rel="stylesheet" type="text/css" href="/css/pygments.css" />
	
	<link rel="icon" href="/images/favicon.png" type="image/png" />

</head>


	<body class="blog">


	<div class="wrapper">

		<div class="header_wrap">
			<a class="header" href="/" title="tom bh" rel="home">
				<div class="blog-title">
					<span>
						<img class="heart_logo" src="/images/heart_logo.png" width="100" alt="Watercolour Heart Logo" />
						tom bh
					</span>
				</div>
				<div class="blog-description">#Web Developer<br />#Meditator</div>
			</a>


			<div class="menu">
				<ul>
					<li>
						<a href="/blog" class="blog">Blog</a>
					</li>
					<li>
						<a href="/about" class="about">About</a>
					</li>
					<li>
						<a href="/showcase" class="showcase">Showcase</a>
					</li>
					<li>
						<a href="http://twitter.com/twombh" target="_blank"><img src="/images/twitter.png" alt="Follow me on Twitter" /></a>
					</li>
				</ul>
			</div>
			<div style="clear:both"></div>

		</div>

		<div style="clear:both"></div>

		<div classs="container">
			<div class="content">

				<h1>#uksnow timelapse</h1>

<span class="post_date">19 January 2010</span>

<p>I love snow, it makes everywhere look so beautiful and clean, plus it disrupts all those boring things like work and school. So I also love <a href="http://uksnow.benmarsh.co.uk">Ben Marsh's Twitter mashup</a> that plots #uksnow tagged tweets onto a map. Watching Ben's map I itched to see the ebb, flow and movement of the tweets across the country, did they form perceivable fronts that reflected the paths of weather systems?</p>

<p>So I did a little research, realised it was within my skill level, and started building. Three days and some late nights later, <em>et voila</em>;</p>

<p><a href="http://uksnow.tombh.co.uk"><img src="http://www.tombh.co.uk/wordpress/wp-content/uploads/2010/01/timelapse_screen.jpg" alt="timelapse_screen" /></a></p>

<div style="clear: both"></div>


<p><a href="http://uksnow.tombh.co.uk">Go check it out »</a></p>

<h2>The basic recipe</h2>

<ul>
<li><p>1 x <a href="http://code.google.com/apis/maps/documentation/">Google Maps API</a>, version 2, client-side.</p></li>
<li><p>1 x <a href="http://code.google.com/apis/maps/articles/phpsqlgeocode.html">Google geocoding API</a>, server-side.</p></li>
<li><p>3 x Cron jobs.</p></li>
<li><p>2 x cached MySQL tables of Twitter search data.</p></li>
<li><p>1 x helping of jQuery.</p></li>
</ul>


<h2>Twitter Search</h2>

<p>First pre-heat your Twitter search archive as soon as possible because you can only really search about a week into the past, beyond that tweets become lost to the search engine.</p>

<p>Twitter's search API is dead easy to use, though I must say it took me a while to realise that it didn't need an API key. My number one tip would be to just use the "Advanced search" option on their website to prototype your search and then just copy the resulting URL from your address bar as the working template for your code. Now, in order to overcome their limitation of 100 results per request you're going to need to get the smallest ID from the first result set and pass that as the "max_id" argument to the second query. This way you can "walk" all the way back to the very oldest results that Twitter supplies.</p>

<p>No-one really knows what the quota is for search API requests, though they do say it is generous, I've never hit it anyway.</p>

<h2>Geocoding</h2>

<p>So once you've collected a bunch of tweets — I did this through cron jobs (though all the APIs here will work client-side as well) — you'll want to regex for postcodes and get some lat/long co-ordinates through geocoding. Again, Google's geocoding API doesn't actually need an API key, it'll let you just query it anyway, but bear in mind that you have 15,000 requests per day. Here's the PHP function I used;</p>

<div class="highlight"><pre><code class="language-perl" data-lang="perl"><span class="n">function</span> <span class="n">getLatLong</span><span class="p">(</span><span class="nv">$postcode</span><span class="p">){</span>
  <span class="n">global</span> <span class="nv">$geo_delay</span><span class="p">;</span>

  <span class="nv">$request_url</span> <span class="o">=</span> <span class="s">&quot;http://maps.google.co.uk/maps/geo?output=xml&amp;q=&quot;</span> <span class="o">.</span> <span class="n">urlencode</span><span class="p">(</span><span class="nv">$postcode</span><span class="p">)</span> <span class="o">.</span> <span class="s">&quot;&amp;gl=gb&quot;</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">FALSE</span> <span class="o">===</span> <span class="nv">$xml</span> <span class="o">=</span> <span class="nv">@simplexml_load_file</span><span class="p">(</span><span class="nv">$request_url</span><span class="p">)</span> <span class="p">)</span> <span class="k">return</span> <span class="s">&#39;again&#39;</span><span class="p">;</span>

  <span class="nv">$status</span> <span class="o">=</span> <span class="nv">$xml</span><span class="o">-&gt;</span><span class="n">Response</span><span class="o">-&gt;</span><span class="n">Status</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="nv">$status</span><span class="p">,</span> <span class="s">&quot;200&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
    <span class="sr">//</span> <span class="n">Successful</span> <span class="n">geocode</span>
    <span class="nv">$coordinates</span> <span class="o">=</span> <span class="nv">$xml</span><span class="o">-&gt;</span><span class="n">Response</span><span class="o">-&gt;</span><span class="n">Placemark</span><span class="o">-&gt;</span><span class="n">Point</span><span class="o">-&gt;</span><span class="n">coordinates</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">,</span> <span class="nv">$coordinates</span><span class="p">);</span>
  <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="nv">$status</span><span class="p">,</span> <span class="s">&quot;620&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="nv">$status</span><span class="p">,</span> <span class="s">&quot;403&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">){</span>
    <span class="sr">//</span> <span class="n">sent</span> <span class="n">geocodes</span> <span class="n">too</span> <span class="n">fast</span>
    <span class="nv">$geo_delay</span> <span class="o">+=</span> <span class="mi">1000</span><span class="p">;</span>
    <span class="k">return</span> <span class="s">&#39;again&#39;</span><span class="p">;</span>
  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="sr">//</span> <span class="n">failure</span> <span class="n">to</span> <span class="n">geocode</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></div>


<h2><strong>The Google Map</strong></h2>

<p>Getting the map on there is dead easy, all I've got is;</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">GMap2</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;map&quot;</span><span class="p">));</span>
<span class="nx">map</span><span class="p">.</span><span class="nx">setMapType</span><span class="p">(</span><span class="nx">G_SATELLITE_MAP</span><span class="p">);</span>
<span class="nx">map</span><span class="p">.</span><span class="nx">addControl</span><span class="p">(</span><span class="k">new</span> <span class="nx">GLargeMapControl3D</span><span class="p">());</span>
<span class="nx">map</span><span class="p">.</span><span class="nx">addControl</span><span class="p">(</span><span class="k">new</span> <span class="nx">GMapTypeControl</span><span class="p">());</span>
<span class="nx">map</span><span class="p">.</span><span class="nx">addMapType</span><span class="p">(</span><span class="nx">G_PHYSICAL_MAP</span><span class="p">);</span>
<span class="nx">map</span><span class="p">.</span><span class="nx">enableScrollWheelZoom</span><span class="p">();</span>
<span class="nx">map</span><span class="p">.</span><span class="nx">enableContinuousZoom</span><span class="p">();</span>
<span class="nx">map</span><span class="p">.</span><span class="nx">setCenter</span><span class="p">(</span><span class="k">new</span> <span class="nx">GLatLng</span><span class="p">(</span><span class="mf">54.16243396806781</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.955078125</span><span class="p">),</span> <span class="mi">5</span><span class="p">);</span></code></pre></div>


<p>Then for adding a snowflake I have a little helper function;</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">createMarker</span><span class="p">(</span><span class="nx">point</span><span class="p">,</span> <span class="nx">handle</span><span class="p">,</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">score</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">icon</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">GIcon</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">marker</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">GMarker</span><span class="p">(</span><span class="nx">point</span><span class="p">,</span> <span class="nx">icon</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">size</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="nx">score</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">middle</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span> <span class="nx">size</span> <span class="o">/</span> <span class="mi">2</span> <span class="p">);</span>
    <span class="nx">icon</span><span class="p">.</span><span class="nx">image</span> <span class="o">=</span> <span class="s2">&quot;/images/snow10.png&quot;</span><span class="p">;</span>
    <span class="nx">icon</span><span class="p">.</span><span class="nx">iconSize</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">GSize</span><span class="p">(</span><span class="nx">size</span><span class="p">,</span> <span class="nx">size</span><span class="p">);</span>
    <span class="nx">icon</span><span class="p">.</span><span class="nx">iconAnchor</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">GPoint</span><span class="p">(</span><span class="nx">middle</span><span class="p">,</span> <span class="nx">middle</span><span class="p">);</span>
    <span class="nx">icon</span><span class="p">.</span><span class="nx">infoWindowAnchor</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">GPoint</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">html</span> <span class="o">=</span> <span class="s1">&#39;&lt;img class=&quot;profile_pic&quot; src=&quot;http://spiurl.appspot.com/&#39;</span> <span class="o">+</span> <span class="nx">handle</span> <span class="o">+</span> <span class="s1">&#39;&quot; /&gt;&lt;div class=&quot;tweet_body&quot;&gt;&#39;</span> <span class="o">+</span> <span class="nx">content</span> <span class="o">+</span> <span class="s1">&#39;&lt;/div&gt;&#39;</span><span class="p">;</span>
    <span class="nx">GEvent</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="nx">marker</span><span class="p">,</span> <span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="nx">marker</span><span class="p">.</span><span class="nx">openInfoWindowHtml</span><span class="p">(</span><span class="nx">html</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">marker</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>


<p>And then you simply do this to get a flake on the map;</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">point</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">GPoint</span><span class="p">(</span><span class="nx">flakes</span><span class="p">[</span><span class="nx">count</span><span class="p">][</span><span class="s1">&#39;lng&#39;</span><span class="p">],</span> <span class="nx">flakes</span><span class="p">[</span><span class="nx">count</span><span class="p">][</span><span class="s1">&#39;lat&#39;</span><span class="p">]);</span>
<span class="kd">var</span> <span class="nx">marker</span> <span class="o">=</span> <span class="nx">createMarker</span><span class="p">(</span><span class="nx">point</span><span class="p">,</span> <span class="nx">flakes</span><span class="p">[</span><span class="nx">count</span><span class="p">][</span><span class="s1">&#39;handle&#39;</span><span class="p">],</span> <span class="nx">flakes</span><span class="p">[</span><span class="nx">count</span><span class="p">][</span><span class="s1">&#39;content&#39;</span><span class="p">],</span> <span class="nx">flakes</span><span class="p">[</span><span class="nx">count</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]);</span>
<span class="nx">map</span><span class="p">.</span><span class="nx">addOverlay</span><span class="p">(</span><span class="nx">marker</span><span class="p">);</span></code></pre></div>


<p>That flakes[] array is the one that stores all the data that I've been archiving from Twitter searches. It's a JSON encoded MySQL result set. So then all I've done is iterate over the entire array plotting each tweet and removing it once it's 60 mins older than the newest.</p>

<h2>Serving Suggestion</h2>

<p>I'm still yet to iron out some performance issues, it seems that there is a bit of stuttering when the map contains 1000+ tweets. Doing some Firebug profiling it looks at first glance to be to do with the way I'm locating rendered flakes using jQuery's CSS selector. Recent webkit browsers certainly fair better here.</p>

<p>Of course the UI is just icing on the cake, but I'd heartily recommend the jQuery UI plugin that gives you very usable sliders out of the box.</p>

<p>Best served with a warm Rioja.</p>


			</div><!-- #content -->
		</div><!-- #container -->

	</div><!-- #wrapper .hfeed -->
	
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
	
	<script src="/js/main.js"></script>

	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-26149594-1']);
		_gaq.push(['_setDomainName', 'tombh.co.uk']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>

</body>
</html>
